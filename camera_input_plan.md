# ソース画像へのカメラ入力機能追加計画

## 概要

既存のファイルアップロード機能に加え、デバイスのカメラから直接画像を撮影してソース画像として設定する機能を追加する。

## 確定計画

1. **UIの追加**:
    * 既存のファイル選択エリアの下部に「カメラで撮影」ボタンを追加する。
    * カメラ起動時に、ファイル選択エリアを置き換える形で、`<video>` 要素（カメラ映像表示用）、撮影ボタン、キャンセルボタンを表示する。
    * 内部的に `<canvas>` 要素を使用して撮影した画像を処理する。
2. **カメラ機能の実装**:
    * 「カメラで撮影」ボタンクリックで `navigator.mediaDevices.getUserMedia` を使用してカメラ映像を取得し、`<video>` に表示する。
    * 「撮影」ボタンクリックで `<video>` のフレームを `<canvas>` に描画し、Blob を生成、`File` オブジェクトに変換してプレビューを作成し、`useAppStore` の `setImage` で状態を更新する。
    * 「キャンセル」ボタンクリックまたは画像削除時にカメラストリームを停止する。
3. **状態管理**:
    * `ImageUploader` コンポーネント内に `isCameraOpen` ローカルステートを追加し、ファイル選択UIとカメラUIの表示を切り替える。
4. **エラーハンドリング**:
    * カメラアクセス拒否やエラー発生時には、ファイル選択エリア内にエラーメッセージを表示する。
5. **機能対象**:
    * この機能は静止画のソース画像入力専用とする。

## 処理フロー図 (Mermaid)

```mermaid
graph TD
    subgraph ImageUploader Component
        A[初期状態: 画像未選択] --> B{ファイル選択 or カメラ?};
        B -- ファイル選択 --> C[ファイル選択UI (クリック/D&D)];
        B -- カメラ --> D[カメラ起動ボタン (エリア下部)];

        C -- ファイル入力 --> E(handleFileChange / handleDrop);
        E --> F(createPreviewFromFile);
        F --> G(setImage);
        G --> H[画像プレビュー表示];

        D -- クリック --> I{カメラアクセス許可?};
        I -- OK --> J[カメラUI表示 (<video>, 撮影/キャンセル)];
        I -- NG --> K[エラーメッセージ表示 (エリア内) & Aに戻る];

        J -- 撮影クリック --> L(キャプチャ処理);
        L --> M(Canvas描画 & Blob生成);
        M --> N(Fileオブジェクト変換 & プレビュー生成);
        N --> G;

        J -- キャンセルクリック --> O(カメラ停止処理);
        O --> A;

        H --> P[削除ボタン];
        P -- クリック --> Q(handleClear & カメラ停止);
        Q --> A;
    end

    subgraph Zustand Store (useAppStore)
        G -- 更新 --> R[sourceImage / videoSourceImage];
        Q -- 更新 --> R;
    end
```
